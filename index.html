<!doctype html>

<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>×”×¨×¦×ª ×§×™×¦×•×¨×™×</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #f3f3f3;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ××¡×š ×¨××©×™ ×™×¤×” */
    #mainScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    #mainScreen.hidden { display: none; }

    /* ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª */
    .settingsBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .settingsBtn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .settingsBtn svg {
      width: 24px;
      height: 24px;
      stroke: #fff;
    }

    /* ×›×•×ª×¨×ª ×¨××©×™×ª */
    .mainTitle {
      font-size: 42px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 60px;
      text-align: center;
      animation: fadeInUp 0.8s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ××–×•×¨ ×× ×™××¦×™×” */
    .animationContainer {
      width: 280px;
      height: 280px;
      position: relative;
      margin-bottom: 40px;
    }

    /* ×§×™×¦×•×¨×™× ××¡×ª×•×‘×‘×™× */
    .shortcut {
      position: absolute;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      animation: orbit 8s linear infinite;
    }

    .shortcut:nth-child(1) { animation-delay: 0s; }
    .shortcut:nth-child(2) { animation-delay: -2s; }
    .shortcut:nth-child(3) { animation-delay: -4s; }
    .shortcut:nth-child(4) { animation-delay: -6s; }

    @keyframes orbit {
      0% {
        transform: rotate(0deg) translateX(110px) rotate(0deg);
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
      100% {
        transform: rotate(360deg) translateX(110px) rotate(-360deg);
        opacity: 1;
      }
    }

    /* ×× ×™××¦×™×™×ª ×§×™×¦×•×¨ ×‘×•×“×“ (×›×©× ×¤×ª×— ×push) */
    .shortcutSingle {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 16px 64px rgba(102, 126, 234, 0.6);
      }
    }

    .shortcutName {
      margin-top: 30px;
      font-size: 24px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ××¡×š ×”×’×“×¨×•×ª */
    #settingsScreen {
      display: none;
      padding: 20px;
      min-height: 100vh;
      animation: slideIn 0.3s ease;
    }

    #settingsScreen.visible { display: block; }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .closeBtn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 20px;
      color: #fff;
      cursor: pointer;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .closeBtn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 24px;
      max-width: 720px;
      backdrop-filter: blur(20px);
      margin-bottom: 20px;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      font-weight: 600;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    button {
      border: 0;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    button.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    button.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    button.warn {
      background: #ffb74d;
      color: #000;
    }

    button.warn:hover {
      background: #ffa726;
      transform: translateY(-2px);
    }

    .muted {
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      line-height: 1.5;
      margin: 10px 0;
    }

    pre {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
    }

    code {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    }

    .ok { color: #6bff95; }
    .bad { color: #ff6b6b; }

    .debugBox {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
    }

    h3 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 600;
    }

    #actionArea {
      margin-top: 15px;
    }

    /* ××¡×š ×¨××©×•× ×™ (setup) */
    #setupScreen {
      display: none;
      padding: 20px;
      min-height: 100vh;
    }

    #setupScreen.visible { display: block; }
  </style>

</head>
<body>

<!-- ××¡×š ×¨××©×™ ×™×¤×” -->

<div id="mainScreen">
  <button class="settingsBtn" onclick="showSettings()">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  </button>

  <h1 class="mainTitle" id="mainTitle">×”×¨×¦×ª ×§×™×¦×•×¨×™×</h1>

  <div class="animationContainer" id="animationContainer">
    <!-- ×× ×™××¦×™×” ×“×™× ××™×ª ×ª×™×•×•×¦×¨ ×›××Ÿ -->
  </div>

  <div class="shortcutName" id="shortcutName" style="display:none;"></div>
</div>

<!-- ××¡×š ×”×’×“×¨×•×ª -->

<div id="settingsScreen">
  <button class="closeBtn" onclick="hideSettings()">
    â† ×—×–×¨×”
  </button>

  <div class="card">
    <h1>ğŸ”§ ×”×’×“×¨×•×ª ×•××™×“×¢</h1>

```
<div class="muted">
  ×ª×•××š ×‘×©×ª×™ ×©×™×˜×•×ª: <b>pushUrl</b> (×× ×”×©×¨×ª ×‘×××ª ××¢×‘×™×¨ url) + <b>pushBody</b> (fallback).<br>
  ×× ×¤×ª×™×—×” ××•×˜×•××˜×™×ª × ×—×¡××ª â€“ ×™×© ×›×¤×ª×•×¨ ×™×“× ×™.
</div>

<div class="row" style="margin-top:16px;">
  <button id="btnInit" class="secondary">1) ××ª×—×œ (×¨×™×©×•× SW)</button>
  <button id="btnPermission" class="primary">2) ×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button>
  <button id="btnSubscribe" class="primary">3) ×¦×•×¨ ×× ×•×™ Push</button>
</div>

<div class="muted" id="statusLine">×¡×˜×˜×•×¡: ××•×›×Ÿ</div>

<div class="debugBox">
  <h3>ğŸ“© ××” ×”×’×™×¢ ××”-Push</h3>
  <div class="muted">pushUrl (××”-URL parameter):</div>
  <pre id="pushUrlBox">â€”</pre>

  <div class="muted">pushBody (××”-URL parameter):</div>
  <pre id="pushRaw">â€”</pre>

  <div class="muted">×¤×™×¢× ×•×— SHORTCUT/PARAM ××”-body:</div>
  <pre id="pushParsed">â€”</pre>

  <div class="muted">×”×§×™×©×•×¨ ×©×™×™×¤×ª×— ×‘×¤×•×¢×œ:</div>
  <pre id="finalUrlBox">â€”</pre>

  <div id="actionArea" style="display:none;">
    <button id="btnRunShortcut" class="warn">â–¶ï¸ ×”×¤×¢×œ ×™×“× ×™×ª</button>
  </div>
</div>

<h3 style="margin:20px 0 12px;">×œ×•×’</h3>
<pre id="log"><code></code></pre>
```

  </div>
</div>

<!-- ××¡×š Setup ×¨××©×•× ×™ -->

<div id="setupScreen">
  <div class="card">
    <h1>ğŸš€ ×”×’×“×¨×” ×¨××©×•× ×™×ª</h1>

```
<div class="muted">
  ×–×•×”×™ ×”×¤×¢× ×”×¨××©×•× ×” ×©××ª×” ×¤×•×ª×— ××ª ×”××¤×œ×™×§×¦×™×”.<br>
  ×™×© ×œ×”×’×“×™×¨ ×”×¨×©××•×ª ×”×ª×¨××•×ª ×•×¨×™×©×•× Push.
</div>

<div class="row" style="margin-top:20px;">
  <button id="btnInit2" class="secondary">1) ××ª×—×œ Service Worker</button>
  <button id="btnPermission2" class="primary">2) ×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button>
  <button id="btnSubscribe2" class="primary">3) ×¦×•×¨ ×× ×•×™ Push</button>
</div>

<div class="muted" id="statusLine2" style="margin-top:16px;">×¡×˜×˜×•×¡: ×××ª×™×Ÿ ×œ×”×’×“×¨×”</div>

<h3 style="margin:20px 0 12px;">×œ×•×’</h3>
<pre id="log2"><code></code></pre>
```

  </div>
</div>

<script>
/* =========================
   ×”×’×“×¨×•×ª
========================= */

const VAPID_PUBLIC_KEY =
  "BAp0IsBi_hZVABIWbGTulbZBur4MxL_dboeLimq2sxAvhN_B8WbNPY6g_mqutJVC3LhOWAnDQNwXujQzYNR3s0U";

const SERVER_SUBSCRIBE_URL =
  "https://subscribe-bdqjci4y3a-uc.a.run.app";

/* =========================
   Local Storage
========================= */

const STORAGE_KEY = "pwa_push_setup_done";

function isSetupDone() {
  return localStorage.getItem(STORAGE_KEY) === "true";
}

function markSetupDone() {
  localStorage.setItem(STORAGE_KEY, "true");
}

/* =========================
   UI helpers
========================= */

const $log = document.querySelector("#log code");
const $log2 = document.querySelector("#log2 code");
const $status = document.querySelector("#statusLine");
const $status2 = document.querySelector("#statusLine2");

function log(...args) {
  const line = args.map(a => typeof a === "string" ? a : JSON.stringify(a, null, 2)).join(" ");
  $log.textContent += line + "\n";
  $log.parentElement.scrollTop = $log.parentElement.scrollHeight;
  
  // ×’× ×œ×œ×•×’ ×”×©× ×™
  $log2.textContent += line + "\n";
  $log2.parentElement.scrollTop = $log2.parentElement.scrollHeight;
}

function setStatus(text, ok=true) {
  const html = `×¡×˜×˜×•×¡: <span class="${ok ? "ok":"bad"}">${text}</span>`;
  $status.innerHTML = html;
  $status2.innerHTML = html;
}

/* =========================
   × ×™×•×•×˜ ××¡×›×™×
========================= */

function showSettings() {
  document.getElementById("mainScreen").classList.add("hidden");
  document.getElementById("settingsScreen").classList.add("visible");
}

function hideSettings() {
  document.getElementById("settingsScreen").classList.remove("visible");
  document.getElementById("mainScreen").classList.remove("hidden");
}

function showSetup() {
  document.getElementById("mainScreen").style.display = "none";
  document.getElementById("setupScreen").classList.add("visible");
}

function showMain() {
  document.getElementById("setupScreen").classList.remove("visible");
  document.getElementById("mainScreen").style.display = "flex";
}

/* =========================
   Web Push â€“ ×¨×™×©×•×
========================= */

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

let swReg = null;

async function initServiceWorker() {
  if (!("serviceWorker" in navigator)) {
    setStatus("Service Worker ×œ× × ×ª××š", false);
    return;
  }
  swReg = await navigator.serviceWorker.register("./sw.js");
  setStatus("Service Worker × ×¨×©× âœ“");
  log("SW scope:", swReg.scope);
}

async function requestPermission() {
  const p = await Notification.requestPermission();
  setStatus("×”×¨×©××”: " + p, p === "granted");
}

async function subscribePush() {
  if (!swReg) {
    setStatus("×¦×¨×™×š ××ª×—×•×œ ×§×•×“×", false);
    return;
  }

  const sub = await swReg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });

  await fetch(SERVER_SUBSCRIBE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub.toJSON()),
  });

  setStatus("× ×•×¦×¨ ×× ×•×™ Push âœ“");
  log("Subscription:", sub.toJSON());
  
  // ×¡×™××•×Ÿ ×©×”×”×’×“×¨×” ×”×•×©×œ××”
  markSetupDone();
  
  // ××¢×‘×¨ ×œ××¡×š ×”×¨××©×™
  setTimeout(() => {
    showMain();
  }, 1000);
}

/* =========================
   Push â†’ ×§×™×¦×•×¨ ×“×¨×š
========================= */

let lastFinalUrl = null;

function getParam(name) {
  return new URLSearchParams(location.search).get(name) || "";
}

function parseBody(body) {
  const out = {};
  body.split(";").forEach(p => {
    const [k, v] = p.split("=");
    if (k && v) out[k.trim()] = v.trim();
  });
  return out;
}

function buildShortcutUrl(name, param) {
  let url = "shortcuts://run-shortcut?name=" + encodeURIComponent(name);
  if (param) url += "&input=text&text=" + encodeURIComponent(param);
  return url;
}

function tryOpen(url) {
  lastFinalUrl = url;
  document.getElementById("finalUrlBox").textContent = url;
  document.getElementById("actionArea").style.display = "block";

  log("ğŸš€ trying to open:", url);

  // × ×™×¡×™×•×Ÿ ××•×˜×•××˜×™
  setTimeout(() => {
    window.location.href = url;
  }, 700);
}

/* =========================
   ×× ×™××¦×™×•×ª
========================= */

function createOrbitAnimation() {
  const container = document.getElementById("animationContainer");
  container.innerHTML = `
    <div class="shortcut">âš¡</div>
    <div class="shortcut">ğŸ¯</div>
    <div class="shortcut">ğŸš€</div>
    <div class="shortcut">â­</div>
  `;
}

function createSingleAnimation(name) {
  const container = document.getElementById("animationContainer");
  container.innerHTML = '<div class="shortcutSingle">âš¡</div>';
  
  document.getElementById("mainTitle").textContent = name || "××¨×™×¥ ×§×™×¦×•×¨...";
  document.getElementById("shortcutName").style.display = "block";
  document.getElementById("shortcutName").textContent = name || "";
}

/* =========================
   ×˜×™×¤×•×œ ×‘×”×•×“×¢×•×ª Push
========================= */

function handlePushData(pushUrl, pushBody) {
  log("pushUrl =", pushUrl || "(empty)");
  log("pushBody =", pushBody || "(empty)");
  
  // ×¢×“×›×•×Ÿ ×ª×™×‘×•×ª ×”××™×“×¢
  document.getElementById("pushUrlBox").textContent = pushUrl ? pushUrl : "â€”";
  document.getElementById("pushRaw").textContent = pushBody ? pushBody : "â€”";
  
  const parsed = pushBody ? parseBody(pushBody) : {};
  document.getElementById("pushParsed").textContent =
    Object.keys(parsed).length ? JSON.stringify(parsed, null, 2) : "â€”";
  
  // âœ… ×¢×“×™×¤×•×ª 1: ×× ×”×’×™×¢ pushUrl ×•×”×•× ×›×‘×¨ shortcuts:// â†’ ×¤×•×ª×—×™× ××•×ª×•
  if (pushUrl && pushUrl.startsWith("shortcuts://")) {
    setStatus("× ×¤×ª×— ×-Push (pushUrl) âœ“");
    
    // ×—×™×œ×•×¥ ×©× ×”×§×™×¦×•×¨
    try {
      const url = new URL(pushUrl);
      const shortcutName = url.searchParams.get("name") || "×§×™×¦×•×¨";
      createSingleAnimation(shortcutName);
    } catch {
      createSingleAnimation("×§×™×¦×•×¨");
    }
    
    tryOpen(pushUrl);
    return true;
  }
  
  // âœ… ×¢×“×™×¤×•×ª 2: ×× ×œ× ×”×’×™×¢ url, × ×‘× ×” ××”-body
  if (parsed.SHORTCUT) {
    const url = buildShortcutUrl(parsed.SHORTCUT, parsed.PARAM || "");
    setStatus("× ×¤×ª×— ×-Push (pushBody) âœ“");
    
    createSingleAnimation(parsed.SHORTCUT);
    tryOpen(url);
    return true;
  }
  
  return false;
}

/* =========================
   ××ª×—×•×œ
========================= */

window.addEventListener("load", () => {
  const pushUrl = decodeURIComponent(getParam("pushUrl"));
  const pushBody = decodeURIComponent(getParam("pushBody"));

  // ×‘×“×™×§×” ×× ×–×• ×¤×ª×™×—×” ×¨××©×•× ×”
  if (!isSetupDone()) {
    showSetup();
    return;
  }

  // ×˜×™×¤×•×œ ×‘× ×ª×•× ×™ Push ×× ×™×©
  const hadPushData = handlePushData(pushUrl, pushBody);
  
  if (!hadPushData) {
    // ××—×¨×ª: ×¤×ª×™×—×” ×¨×’×™×œ×” ×¢× ×× ×™××¦×™×” ××¡×ª×•×‘×‘×ª
    setStatus("×¤×ª×™×—×” ×¨×’×™×œ×” âœ“");
    createOrbitAnimation();
    document.getElementById("finalUrlBox").textContent = "â€”";
    document.getElementById("actionArea").style.display = "none";
  }
});

/* =========================
   ×××–×™×Ÿ ×œ×”×•×“×¢×•×ª ××”-Service Worker
========================= */

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'PUSH_RECEIVED') {
      log("ğŸ“¨ ×§×™×‘×œ× ×• ×”×•×“×¢×ª Push ×‘×–××Ÿ ×©×”×“×£ ×¤×ª×•×—!");
      
      const pushUrl = event.data.pushUrl || "";
      const pushBody = event.data.pushBody || "";
      
      handlePushData(pushUrl, pushBody);
    }
  });
}

/* =========================
   ×›×¤×ª×•×¨×™×
========================= */

document.getElementById("btnRunShortcut").onclick = () => {
  if (lastFinalUrl) window.location.href = lastFinalUrl;
};

// ××¡×š ×”×’×“×¨×•×ª
btnInit.onclick = initServiceWorker;
btnPermission.onclick = requestPermission;
btnSubscribe.onclick = subscribePush;

// ××¡×š setup
btnInit2.onclick = initServiceWorker;
btnPermission2.onclick = requestPermission;
btnSubscribe2.onclick = subscribePush;

setStatus("××•×›×Ÿ");
</script>

</body>
</html>