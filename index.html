<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PWA Push â€“ ×‘×“×™×§×”</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin:0; padding:18px; background:#0b0b0b; color:#f3f3f3; }
    .card { background:#151515; border:1px solid #2a2a2a; border-radius:14px; padding:14px; max-width:720px; }
    h1 { margin:0 0 10px; font-size:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
    button { border:0; border-radius:12px; padding:10px 12px; font-size:14px; cursor:pointer; }
    button.primary { background:#2e7dff; color:#fff; }
    button.secondary { background:#2a2a2a; color:#fff; }
    button.warn { background:#ffb74d; color:#000; }
    .muted { color:#bdbdbd; font-size:13px; line-height:1.35; }
    pre { background:#0f0f0f; border:1px solid #262626; border-radius:12px; padding:12px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
    .ok { color:#6bff95; }
    .bad { color:#ff6b6b; }
    .debugBox { margin-top:14px; background:#0f0f0f; border:1px dashed #3a3a3a; border-radius:12px; padding:12px; }
  </style>
</head>
<body>

<div class="card">
  <h1>ğŸ“² PWA Push â€“ ×“×£ ×‘×“×™×§×”</h1>

  <div class="muted">
    ×ª×•××š ×‘×©×ª×™ ×©×™×˜×•×ª: <b>pushUrl</b> (×× ×”×©×¨×ª ×‘×××ª ××¢×‘×™×¨ url) + <b>pushBody</b> (fallback).<br>
    ×× ×¤×ª×™×—×” ××•×˜×•××˜×™×ª × ×—×¡××ª â€“ ×™×© ×›×¤×ª×•×¨ ×™×“× ×™.
  </div>

  <div class="row" style="margin-top:12px;">
    <button id="btnInit" class="secondary">1) ××ª×—×œ (×¨×™×©×•× SW)</button>
    <button id="btnPermission" class="primary">2) ×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button>
    <button id="btnSubscribe" class="primary">3) ×¦×•×¨ ×× ×•×™ Push</button>
  </div>

  <div class="muted" id="statusLine">×¡×˜×˜×•×¡: â€¦</div>

  <div class="debugBox">
    <h3>ğŸ“© ××” ×”×’×™×¢ ××”-Push</h3>
    <div class="muted">pushUrl (××”Ö¾URL parameter):</div>
    <pre id="pushUrlBox">â€”</pre>

    <div class="muted">pushBody (××”Ö¾URL parameter):</div>
    <pre id="pushRaw">â€”</pre>

    <div class="muted">×¤×™×¢× ×•×— SHORTCUT/PARAM ××”Ö¾body:</div>
    <pre id="pushParsed">â€”</pre>

    <div class="muted">×”×§×™×©×•×¨ ×©×™×™×¤×ª×— ×‘×¤×•×¢×œ:</div>
    <pre id="finalUrlBox">â€”</pre>

    <div id="actionArea" style="display:none;margin-top:10px">
      <button id="btnRunShortcut" class="warn">â–¶ï¸ ×”×¤×¢×œ ×™×“× ×™×ª</button>
    </div>
  </div>

  <h3 style="margin:14px 0 8px; font-size:15px;">×œ×•×’</h3>
  <pre id="log"><code></code></pre>
</div>

<script>
/* =========================
   ×”×’×“×¨×•×ª (×›××• ××¦×œ×š)
========================= */

const VAPID_PUBLIC_KEY =
  "BAp0IsBi_hZVABIWbGTulbZBur4MxL_dboeLimq2sxAvhN_B8WbNPY6g_mqutJVC3LhOWAnDQNwXujQzYNR3s0U";

const SERVER_SUBSCRIBE_URL =
  "https://subscribe-bdqjci4y3a-uc.a.run.app";

/* =========================
   UI helpers
========================= */

const $log = document.querySelector("#log code");
const $status = document.querySelector("#statusLine");

function log(...args) {
  const line = args.map(a => typeof a === "string" ? a : JSON.stringify(a, null, 2)).join(" ");
  $log.textContent += line + "\n";
  $log.parentElement.scrollTop = $log.parentElement.scrollHeight;
}

function setStatus(text, ok=true) {
  $status.innerHTML = `×¡×˜×˜×•×¡: <span class="${ok ? "ok":"bad"}">${text}</span>`;
}

/* =========================
   Web Push â€“ ×¨×™×©×•×
========================= */

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

let swReg = null;

async function initServiceWorker() {
  if (!("serviceWorker" in navigator)) {
    setStatus("Service Worker ×œ× × ×ª××š", false);
    return;
  }
  swReg = await navigator.serviceWorker.register("./sw.js");
  setStatus("Service Worker × ×¨×©× âœ“");
  log("SW scope:", swReg.scope);
}

async function requestPermission() {
  const p = await Notification.requestPermission();
  setStatus("×”×¨×©××”: " + p, p === "granted");
}

async function subscribePush() {
  if (!swReg) {
    setStatus("×¦×¨×™×š ××ª×—×•×œ ×§×•×“×", false);
    return;
  }

  const sub = await swReg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });

  await fetch(SERVER_SUBSCRIBE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub.toJSON()),
  });

  setStatus("× ×•×¦×¨ ×× ×•×™ Push âœ“");
  log("Subscription:", sub.toJSON());
}

/* =========================
   Push â†’ ×§×™×¦×•×¨ ×“×¨×š
========================= */

let lastFinalUrl = null;

function getParam(name) {
  return new URLSearchParams(location.search).get(name) || "";
}

function parseBody(body) {
  const out = {};
  body.split(";").forEach(p => {
    const [k, v] = p.split("=");
    if (k && v) out[k.trim()] = v.trim();
  });
  return out;
}

function buildShortcutUrl(name, param) {
  let url = "shortcuts://run-shortcut?name=" + encodeURIComponent(name);
  if (param) url += "&input=text&text=" + encodeURIComponent(param);
  return url;
}

function tryOpen(url) {
  lastFinalUrl = url;
  document.getElementById("finalUrlBox").textContent = url;
  document.getElementById("actionArea").style.display = "block";

  log("ğŸš€ trying to open:", url);

  // × ×™×¡×™×•×Ÿ ××•×˜×•××˜×™ (×¢×‘×“ ××¦×œ×š)
  setTimeout(() => {
    window.location.href = url;
  }, 700);
}

window.addEventListener("load", () => {
  const pushUrl = decodeURIComponent(getParam("pushUrl"));
  const pushBody = decodeURIComponent(getParam("pushBody"));

  document.getElementById("pushUrlBox").textContent = pushUrl ? pushUrl : "â€”";
  document.getElementById("pushRaw").textContent = pushBody ? pushBody : "â€”";

  const parsed = pushBody ? parseBody(pushBody) : {};
  document.getElementById("pushParsed").textContent =
    Object.keys(parsed).length ? JSON.stringify(parsed, null, 2) : "â€”";

  log("pushUrl param =", pushUrl || "(empty)");
  log("pushBody param =", pushBody || "(empty)");

  // âœ… ×¢×“×™×¤×•×ª 1: ×× ×”×’×™×¢ pushUrl ×•×”×•× ×›×‘×¨ shortcuts:// â†’ ×¤×•×ª×—×™× ××•×ª×•
  if (pushUrl && pushUrl.startsWith("shortcuts://")) {
    setStatus("× ×¤×ª×— ×-Push (pushUrl) âœ“");
    tryOpen(pushUrl);
    return;
  }

  // âœ… ×¢×“×™×¤×•×ª 2: ×× ×œ× ×”×’×™×¢ url, × ×‘× ×” ××”-body
  if (parsed.SHORTCUT) {
    const url = buildShortcutUrl(parsed.SHORTCUT, parsed.PARAM || "");
    setStatus("× ×¤×ª×— ×-Push (pushBody) âœ“");
    tryOpen(url);
    return;
  }

  // ××—×¨×ª: ×¤×ª×™×—×” ×¨×’×™×œ×”
  setStatus("× ×¤×ª×— ×¨×’×™×œ (××™×Ÿ pushUrl/SHORTCUT)", true);
  document.getElementById("finalUrlBox").textContent = "â€”";
  document.getElementById("actionArea").style.display = "none";
});

document.getElementById("btnRunShortcut").onclick = () => {
  if (lastFinalUrl) window.location.href = lastFinalUrl;
};

/* =========================
   ×›×¤×ª×•×¨×™×
========================= */

btnInit.onclick = initServiceWorker;
btnPermission.onclick = requestPermission;
btnSubscribe.onclick = subscribePush;

setStatus("××•×›×Ÿ");
</script>

</body>
</html>