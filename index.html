<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PWA Push â€“ ×‘×“×™×§×”</title>

  <!-- âœ… ×—×•×‘×” ×œ-PWA -->
  <link rel="manifest" href="./manifest.json" />

  <!-- âœ… ××•××œ×¥ ×œ-iOS -->
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin: 0; padding: 18px; background: #0b0b0b; color: #f3f3f3; }
    .card { background: #151515; border: 1px solid #2a2a2a; border-radius: 14px; padding: 14px; max-width: 720px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
    button { border: 0; border-radius: 12px; padding: 10px 12px; font-size: 14px; cursor: pointer; }
    button.primary { background: #2e7dff; color: #fff; }
    button.secondary { background: #2a2a2a; color: #fff; }
    .muted { color: #bdbdbd; font-size: 13px; line-height: 1.35; }
    pre { background: #0f0f0f; border: 1px solid #262626; border-radius: 12px; padding: 12px; overflow: auto; white-space: pre-wrap; word-break: break-word; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .ok { color: #6bff95; }
    .bad { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ“² PWA Push â€“ ×“×£ ×‘×“×™×§×”</h1>
    <div class="muted">
      ×–×” ×“×£ â€œ×©×œ×“â€ ×©××›×™×Ÿ ××ª ×›×œ ×”×“×¨×•×© ×œ-Web Push: Manifest + Service Worker + Permission + Subscription.<br/>
      ×‘-iPad/iOS ×–×” ×™×¢×‘×•×“ ×œ×§×‘×œ×ª Push ×¨×§ ×›×©×”××ª×¨ ××•×ª×§×Ÿ ×œ××¡×š ×”×‘×™×ª ×“×¨×š Safari.
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="btnInit" class="secondary">1) ××ª×—×œ (×¨×™×©×•× SW)</button>
      <button id="btnPermission" class="primary">2) ×‘×§×© ×”×¨×©××ª ×”×ª×¨××•×ª</button>
      <button id="btnSubscribe" class="primary">3) ×¦×•×¨ ×× ×•×™ Push</button>
    </div>

    <div class="muted" id="statusLine">×¡×˜×˜×•×¡: â€¦</div>

    <h3 style="margin:14px 0 8px; font-size:15px;">×œ×•×’</h3>
    <pre id="log"><code></code></pre>
  </div>

  <script>
    // ====== ×”×’×“×¨×•×ª ×©×—×™×™×‘×™× ×œ×”×ª××™× ××¦×œ×š ======

    // âœ… VAPID Public Key (Base64URL) ××”×©×¨×ª ×©×œ×š
    // ×“×•×’××”: "BOr...KQ"  (×–×” ×œ× ×”××¤×ª×— ×”×××™×ª×™)
const VAPID_PUBLIC_KEY = "BIyT1-c4ZPR6dZn6uU0cZAfZdN3lySvRRr1HG7pFQ9r43RSWWUfY0gUVXh4-M06D9nouxgzXKiJA_-bYJRAcgJ8";

    // âœ… URL ×‘×©×¨×ª ×©×œ×š ×©××§×‘×œ subscription ×•×©×•××¨ ××•×ª×•
    // (GitHub Pages ×”×•× ×¡×˜×˜×™, ××– ×—×™×™×‘×™× endpoint ×—×™×¦×•× ×™)
const SERVER_SUBSCRIBE_URL = "https://us-central1-web-push-server-d28f2.cloudfunctions.net/subscribe";

    // ====== UI helpers ======
    const $log = document.querySelector("#log code");
    const $status = document.querySelector("#statusLine");
    function log(...args) {
      const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      $log.textContent += line + "\n";
      $log.parentElement.scrollTop = $log.parentElement.scrollHeight;
      console.log(...args);
    }
    function setStatus(text, ok=true) {
      $status.innerHTML = `×¡×˜×˜×•×¡: <span class="${ok ? "ok":"bad"}">${text}</span>`;
    }

    // ====== Web Push helpers ======
    function urlBase64ToUint8Array(base64String) {
      // Base64URL -> Base64
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    let swReg = null;

    async function initServiceWorker() {
      log("== Init ==");
      if (!("serviceWorker" in navigator)) {
        setStatus("Service Worker ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×”×–×”", false);
        log("âŒ navigator.serviceWorker ×œ× ×§×™×™×");
        return;
      }
      try {
        // ×—×©×•×‘: sw.js ×¦×¨×™×š ×œ×”×™×•×ª ×‘××•×ª×” ×ª×™×§×™×™×” ×›×“×™ ×©×”-scope ×™×”×™×” × ×›×•×Ÿ ×‘-GitHub Pages
        swReg = await navigator.serviceWorker.register("./sw.js");
        setStatus("Service Worker × ×¨×©× âœ”");
        log("âœ… SW registered. scope =", swReg.scope);
      } catch (e) {
        setStatus("× ×›×©×œ ×¨×™×©×•× Service Worker", false);
        log("âŒ SW register failed:", String(e));
      }
    }

    async function requestPermission() {
      log("== Permission ==");
      if (!("Notification" in window)) {
        setStatus("Notification API ×œ× × ×ª××š", false);
        log("âŒ Notification API ×œ× ×§×™×™×");
        return;
      }
      try {
        const p = await Notification.requestPermission(); // ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×œ×—×™×¦×”
        log("Permission =", p);
        if (p === "granted") setStatus("×”×¨×©××” ××•×©×¨×” âœ”");
        else setStatus("×”×¨×©××” ×œ× ××•×©×¨×” (" + p + ")", false);
      } catch (e) {
        setStatus("×©×’×™××” ×‘×‘×§×©×ª ×”×¨×©××”", false);
        log("âŒ requestPermission failed:", String(e));
      }
    }

    async function subscribePush() {
      log("== Subscribe ==");
      if (!swReg) {
        setStatus("×¦×¨×™×š ×§×•×“× ××ª×—×•×œ (×¨×™×©×•× SW)", false);
        log("âŒ swReg is null. ×œ×—×¥ ×¢×œ '××ª×—×œ' ×§×•×“×");
        return;
      }
      if (!("PushManager" in window)) {
        setStatus("Push ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×”×–×”", false);
        log("âŒ PushManager ×œ× ×§×™×™×");
        return;
      }
      if (Notification.permission !== "granted") {
        setStatus("×¦×¨×™×š ×œ××©×¨ ×”×¨×©××ª ×”×ª×¨××•×ª ×§×•×“×", false);
        log("âŒ Notification.permission =", Notification.permission);
        return;
      }
      if (!VAPID_PUBLIC_KEY || VAPID_PUBLIC_KEY.includes("PUT_YOUR")) {
        setStatus("×—×¡×¨ VAPID public key ×‘×§×•×“", false);
        log("âŒ ×¢×“×›×Ÿ VAPID_PUBLIC_KEY");
        return;
      }

      try {
        const existing = await swReg.pushManager.getSubscription();
        if (existing) {
          log("â„¹ï¸ ×›×‘×¨ ×§×™×™× subscription. ××©×ª××©×™× ×‘×•.");
          await sendSubscriptionToServer(existing);
          setStatus("×›×‘×¨ ×”×™×™×ª ×× ×•×™ âœ”");
          logSubscription(existing);
          return;
        }

        const sub = await swReg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
        });

        setStatus("× ×•×¦×¨ ×× ×•×™ Push âœ”");
        logSubscription(sub);

        await sendSubscriptionToServer(sub);
        log("âœ… Subscription × ×©×œ×— ×œ×©×¨×ª");
      } catch (e) {
        setStatus("× ×›×©×œ ×œ×™×¦×•×¨ ×× ×•×™ Push", false);
        log("âŒ subscribe failed:", String(e));
      }
    }

    function logSubscription(sub) {
      const json = sub.toJSON();
      log("endpoint:", json.endpoint);
      log("keys:", json.keys);
      log("subscription JSON:", json);
    }

    async function sendSubscriptionToServer(sub) {
      if (!SERVER_SUBSCRIBE_URL || SERVER_SUBSCRIBE_URL.includes("YOUR_SERVER")) {
        log("âš ï¸ SERVER_SUBSCRIBE_URL ×œ× ××•×’×“×¨. ××“×œ×’×™× ×©×œ×™×—×” ×œ×©×¨×ª.");
        return;
      }
      const payload = sub.toJSON();
      const res = await fetch(SERVER_SUBSCRIBE_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(subscription),
});

      if (!res.ok) throw new Error("Server responded " + res.status);
    }

    // ====== Buttons ======
    document.getElementById("btnInit").addEventListener("click", initServiceWorker);
    document.getElementById("btnPermission").addEventListener("click", requestPermission);
    document.getElementById("btnSubscribe").addEventListener("click", subscribePush);

    // ××¦×‘ ×”×ª×—×œ×ª×™
    setStatus("××•×›×Ÿ. ×œ×—×¥ ×¢×œ 1) ××ª×—×œ");
    log("Ready. URL =", location.href);
  </script>
</body>
</html>
